{% load static %}
<div class="shape shape1"></div>
<div class="shape shape2"></div>
<div class="shape shape3"></div>
<section class="checkout-section position-relative">
    <div class="container">
        <div class="checkout-card shadow-lg">
            <div class="checkout-title mb-4 d-flex align-items-center">
                <i class="fa-solid fa-bag-shopping me-2"></i>
                <span>Checkout</span>
            </div>

            <!-- Order Summary -->
            <div class="order-summary mb-4">
                <div class="order-summary-title">Order Summary</div>
                <ul class="list-group mb-3">
                    {% for item in cart.items.all %}
                    <li class="list-group-item d-flex justify-content-between lh-sm">
                        <div class="d-flex align-items-center">
                            <img src="{{ item.product.image_urls.0 }}" alt="{{ item.product.name }}" 
                                 style="width: 40px; height: 40px; object-fit: cover; margin-right: 10px;">
                            <div>
                                <h6 class="my-0">{{ item.product.name }}</h6>
                                <small class="text-muted">Qty: {{ item.quantity }}</small>
                            </div>
                        </div>
                        <span class="text-muted">₹{{ item.subtotal }}</span>
                    </li>
                    {% endfor %}
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Subtotal:</strong>
                        <strong class="order-totals">₹{{ total }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Courier Charge:</strong>
                        <strong class="courier-charge">₹0</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Final Total:</strong>
                        <strong class="final-total">₹{{ total }}</strong>
                    </li>
                </ul>
            </div>

            <!-- Checkout Form -->
            <form id="checkout-form" class="form-section needs-validation" method="POST" 
                  action="{% url 'place_order' %}" novalidate>
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label">Full Name</label>
                        <div class="input-group has-validation">
                            <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
                            <input type="text" class="form-control" id="name" name="name"
                                   placeholder="Enter your full name"
                                   value="{{ user_data.name }}" required>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="phone" class="form-label">Phone Number</label>
                        <div class="input-group has-validation">
                            <span class="input-group-text"><i class="fa-solid fa-phone"></i></span>
                            <input type="tel" class="form-control" id="phone" name="phone"
                                   placeholder="Enter your phone number"
                                   value="{{ user_data.phone }}" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="pincode" class="form-label">Pincode</label>
                        <input type="text" class="form-control" id="pincode" name="pincode"
                               placeholder="Enter your pincode"
                               value="{{ user_data.pincode|default_if_none:'' }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="city" class="form-label">City</label>
                        <input type="text" class="form-control" id="city" name="city"
                               placeholder="Enter your city"
                               value="{{ user_data.city|default_if_none:'' }}" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="address" class="form-label">Address</label>
                    <textarea class="form-control" id="address" name="address"
                              placeholder="Enter your full address"
                              rows="2" required>{{ user_data.address|default_if_none:'' }}</textarea>
                </div>

                <div class="mb-3">
                    <label for="state" class="form-label">State</label>
                    <input type="text" class="form-control" id="state" name="state"
                           value="Tamil Nadu" required>
                </div>

                <button type="submit" class="btn btn-success w-100 mt-2">
                    <i class="fa-solid fa-check-circle me-2"></i>Place Order via WhatsApp
                </button>
            </form>

            <script>
document.addEventListener('DOMContentLoaded', function () {
    const baseTotal = parseFloat("{{ total }}") || 0;
    const stateInput = document.getElementById('state');
    const courierElem = document.querySelectorAll('.courier-charge');
    const finalElem = document.querySelectorAll('.final-total');

    function updateCharges() {
        let state = stateInput.value.trim().toLowerCase();
        let courierCharge = 0;

        if (state === "tamil nadu" || state === "tamilnadu") {
            courierCharge = baseTotal >= 500 ? 0 : 50;
        } else {
            courierCharge = 100;
        }

        courierElem.forEach(el => el.textContent = "₹" + courierCharge);
        finalElem.forEach(el => el.textContent = "₹" + (baseTotal + courierCharge));
    }

    stateInput.addEventListener('input', updateCharges);
    updateCharges();
});
</script>

        </div>
    </div>
</section>

            
            {% comment %} <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
            <script>
            (function () {
                'use strict';
            
                const form = document.querySelector("form");
            
                function preventFormSubmit(event) {
                    event.preventDefault();
                    event.stopPropagation();
            
                    form.classList.add('was-validated');
            
                    if (form.checkValidity()) {
                        const options = {
                            "key": "{{ razorpay_merchant_key }}",
                            "amount": "{{ amount }}",
                            "currency": "{{ currency }}",
                            "name": "{{ request.user.get_full_name }}",
                            "description": "Order Payment",
                            "order_id": "{{ razorpay_order_id }}",
                            "handler": function (response) {
                                // Remove preventDefault so form can submit
                                form.removeEventListener('submit', preventFormSubmit);
            
                                // Add Razorpay response values
                                ["razorpay_payment_id", "razorpay_order_id", "razorpay_signature"].forEach(key => {
                                    const input = document.createElement("input");
                                    input.type = "hidden";
                                    input.name = key;
                                    input.value = response[key];
                                    form.appendChild(input);
                                });
            
                                // Submit form now
                                form.submit();
                            },
                            "modal": {
                                "ondismiss": function () {
                                    alert("Payment was cancelled.");
                                }
                            },
                            "theme": {
                                "color": "#0d6efd"
                            }
                        };
            
                        const rzp = new Razorpay(options);
                        rzp.open();
                    }
                }
            
                form.addEventListener('submit', preventFormSubmit, false);
            })(); {% endcomment %}
            </script>
            